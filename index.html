<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft AR (Stable)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0; background-color: #1e1e1e; overflow: hidden;
            font-family: 'Press Start 2P', monospace;
            color: white;
        }
        
        #debug-console {
            position: absolute; top: 0; left: 0; width: 300px; height: 200px;
            background: rgba(0, 0, 0, 0.5); 
            padding: 10px; font-size: 10px; z-index: 999;
            overflow-y: auto; pointer-events: none;
            white-space: pre-wrap; font-family: monospace;
            color: #fff; text-shadow: 1px 1px #000;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #control-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center; width: 100%;
        }

        .mc-btn {
            background: #7d7d7d; border: 4px solid #fff; 
            border-bottom-color: #3b3b3b; border-right-color: #3b3b3b;
            padding: 15px 20px; color: #fff; font-family: inherit;
            cursor: pointer; text-shadow: 2px 2px #000; margin: 5px;
        }
        .mc-btn:active { border: 4px solid #3b3b3b; border-bottom-color: #fff; border-right-color: #fff; }
        .mc-btn:disabled { background: #555; color: #888; border-color: #555; cursor: not-allowed; }

        .hidden-asset { display: none; }
    </style>
    
    <script src="https://unpkg.com/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://unpkg.com/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>
<body>

    <div id="debug-console">=== SYSTEM READY ===<br></div>

    <img id="img-steve" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAAFJJREFUWAntlkEOACAIA73/j2bDxSTQAl32MCY8tqxuc639k521P4ssA8yO2AHGIdgBxiHYAcYh2AHGIdgBxiHYAcYh2AHGIdgBxiHYAS7B9tkfF150r83b72ozAAAAAElFTkSuQmCC">
    <img id="img-crafting" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAFdQTFRFAAAA////gICA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAABFvPEeAAAAJ3RSTlMAAAAAExMdHSUlLS0zMz09SUlNTV1dZWVtbfX1////////////////38k19AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAASdAAAEnQB3mYfeAAAAAd0SU1FB+kLHBQtE9S007wAAABTSURBVDjLY2DABpgZkcDMiEzgMsCErhakFocJuxyQOpCwKwCoAwmbAgM2OQxgwi4HoA4k7HIAdSBhlwOoAwm7HEAdSNjlAOrAwq4ApA4k7HIAdSABAF3IAPF/9/Z1AAAAAElFTkSuQmCC">
    <img id="img-planks" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAFdQTFRFAAAA////gICA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAABFvPEeAAAAJ3RSTlMAAAAAExMdHSUlLS0zMz09SUlNTV1dZWVtbfX1////////////////38k19AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAASdAAAEnQB3mYfeAAAAAd0SU1FB+kLHBQtE9S007wAAABTSURBVDjLY2DABpgZkcDMiEzgMsCErhakFocJuxyQOpCwKwCoAwmbAgM2OQxgwi4HoA4k7HIAdSBhlwOoAwm7HEAdSNjlAOrAwq4ApA4k7HIAdSABAF3IAPF/9/Z1AAAAAElFTkSuQmCC">

    <div id="control-panel">
        <button id="btn-camera" class="mc-btn">1. Start Camera</button>
        <button id="btn-load" class="mc-btn" disabled>2. Load AI</button>
        <button id="btn-start-ai" class="mc-btn" disabled>3. Start Detect</button>
    </div>

    <video id="video-source" class="hidden-asset" playsinline muted></video>
    <canvas id="output"></canvas>

<script>
    const debugConsole = document.getElementById('debug-console');
    function log(msg) {
        debugConsole.innerHTML += `> ${msg}<br>`;
        debugConsole.scrollTop = debugConsole.scrollHeight;
    }
    
    window.onerror = function(msg, url, line) {
        log(`ERR: ${msg}`);
    };

    const video = document.getElementById('video-source');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const btnCamera = document.getElementById('btn-camera');
    const btnLoad = document.getElementById('btn-load');
    const btnStartAI = document.getElementById('btn-start-ai');

    const MC_MAP = {
        'person':       { name: 'Steve',            imgId: 'img-steve',    color: '#FFD700' },
        'laptop':       { name: 'Enchanting Table', imgId: 'img-crafting', color: '#b5651d' },
        'tv':           { name: 'Obsidian',         imgId: 'img-crafting', color: '#2a002a' },
        'cell phone':   { name: 'Map',              imgId: 'img-planks',   color: '#ffffff' },
        'dining table': { name: 'Crafting Table',   imgId: 'img-crafting', color: '#8b4513' },
    };

    let model = null;
    let isCameraRunning = false;
    let isAiRunning = false;
    let currentPredictions = [];

    // 1. Camera
    btnCamera.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false, 
                video: { width: 640, height: 480, facingMode: 'environment' }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                isCameraRunning = true;
                resizeCanvas();
                requestAnimationFrame(renderLoop);
                btnCamera.disabled = true;
                btnLoad.disabled = false;
                log("Camera Started.");
            };
        } catch (e) { log("Cam Fail: " + e.message); }
    };

    // 2. Load AI
    btnLoad.onclick = async () => {
        btnLoad.innerText = "Loading...";
        try {
            model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            log("Model Loaded.");
            btnLoad.disabled = true;
            btnStartAI.disabled = false;
        } catch (e) { log("Model Fail: " + e.message); }
    };

    // 3. Start Detect
    btnStartAI.onclick = () => {
        if (!model) return;
        isAiRunning = true;
        predictLoop();
        btnStartAI.disabled = true;
        btnStartAI.innerText = "Scanning...";
        log("Scanning...");
    };

    function renderLoop() {
        if (!isCameraRunning) return;
        
        // 簡單的全螢幕填滿邏輯
        const scale = Math.max(canvas.width / 640, canvas.height / 480);
        const w = 640 * scale;
        const h = 480 * scale;
        const x = (canvas.width - w) / 2;
        const y = (canvas.height - h) / 2;

        ctx.drawImage(video, x, y, w, h);
        
        // 只有不為空時才繪製
        if (currentPredictions.length > 0) {
            drawOverlays(x, y, scale);
        }

        requestAnimationFrame(renderLoop);
    }

    async function predictLoop() {
        if (!isAiRunning) return;
        try {
            // 只在視訊準備好時偵測
            if (video.readyState === 4) {
                currentPredictions = await model.detect(video);
            }
        } catch (e) {
            // log("Predict Skip"); // 忽略單次錯誤
        }
        setTimeout(predictLoop, 50);
    }

    function drawOverlays(startX, startY, scale) {
        currentPredictions.forEach(prediction => {
            if (prediction.score > 0.5) {
                const boxX = prediction.bbox[0] * scale + startX;
                const boxY = prediction.bbox[1] * scale + startY;
                const boxW = prediction.bbox[2] * scale;
                const boxH = prediction.bbox[3] * scale;
                const rawClass = prediction.class.toLowerCase();
                
                let item = MC_MAP[rawClass] || { name: rawClass, imgId: 'img-planks', color: '#aaa' };

                // Draw Box
                ctx.lineWidth = 4; ctx.strokeStyle = item.color; ctx.strokeRect(boxX, boxY, boxW, boxH);

                // Draw Tooltip
                const text = item.name; const iconSize = 32; const padding = 8;
                ctx.font = `16px "Press Start 2P", monospace`;
                const textW = ctx.measureText(text).width;
                const tooltipW = iconSize + textW + padding * 3;
                
                let tx = boxX; let ty = boxY - 50;
                if (ty < 0) ty = boxY + 10;

                ctx.fillStyle = "rgba(16, 0, 16, 0.9)"; 
                ctx.fillRect(tx, ty, tooltipW, 40);
                ctx.strokeStyle = "#300060"; ctx.lineWidth = 2;
                ctx.strokeRect(tx, ty, tooltipW, 40);

                // === 關鍵修正：防崩潰繪圖 (Safe Draw) ===
                const imgElement = document.getElementById(item.imgId);
                
                // 檢查圖片是否載入成功 (complete 且 naturalWidth > 0)
                if (imgElement && imgElement.complete && imgElement.naturalWidth !== 0) {
                    try {
                        // 嘗試畫圖
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(imgElement, tx + padding, ty + 4, iconSize, iconSize);
                    } catch (err) {
                        // 如果畫圖失敗，靜默處理，改畫色塊
                        ctx.fillStyle = item.color;
                        ctx.fillRect(tx + padding, ty + 4, iconSize, iconSize);
                    }
                } else {
                    // 如果圖片壞了，畫色塊代替
                    ctx.fillStyle = item.color;
                    ctx.fillRect(tx + padding, ty + 4, iconSize, iconSize);
                }

                ctx.fillStyle = item.color;
                if (item.name === 'Steve') ctx.fillStyle = '#FFFF55';
                ctx.fillText(text, tx + padding + iconSize + padding, ty + 28);
            }
        });
    }

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.onresize = resizeCanvas;

</script>
</body>
</html>
