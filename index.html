<script>
    // === V2 設定：強化 Minecraft 風格映射 ===
    
    // 這裡定義 "COCO-SSD 辨識出的英文" 對應 "Minecraft 的什麼物品"
    // 鍵值全部使用「小寫」以防萬一
    const MINECRAFT_MAP = {
        'person':       { name: 'Player Head',      color: '#FFD700' }, // 金色
        'cup':          { name: 'Flower Pot',       color: '#cc7722' },
        'bottle':       { name: 'Potion',           color: '#ff55ff' },
        'chair':        { name: 'Oak Stairs',       color: '#b8860b' },
        'couch':        { name: 'Red Wool',         color: '#ff3333' },
        'potted plant': { name: 'Sapling',          color: '#55ff55' },
        'tv':           { name: 'Obsidian',         color: '#330033' },
        'laptop':       { name: 'Enchanting Table', color: '#b5651d' },
        'mouse':        { name: 'Stone Button',     color: '#aaaaaa' },
        'keyboard':     { name: 'Pressure Plate',   color: '#dddddd' },
        'cell phone':   { name: 'Map',              color: '#ffffff' },
        'dining table': { name: 'Crafting Table',   color: '#8b4513' },
        'book':         { name: 'Enchanted Book',   color: '#a020f0' },
    };

    // 預設樣式 (遇到不認識的東西時)
    const DEFAULT_BLOCK = { name: 'Cobblestone', color: '#777777' };

    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const loadingScreen = document.getElementById('loading-screen');
    const startBtn = document.getElementById('start-btn');
    const titleText = document.querySelector('.mc-title');
    const fpsText = document.getElementById('fps-counter');

    let model = null;
    let isDetecting = false;
    let lastTime = 0;

    // 1. 初始化模型
    async function init() {
        try {
            // 載入模型
            model = await cocoSsd.load();
            console.log("Model loaded successfully!");
            
            titleText.innerHTML = "Server Online!<br><span style='font-size:12px;color:#5f5;'>> Ready to join</span>";
            startBtn.style.display = 'block';
            
            startBtn.addEventListener('click', () => {
                loadingScreen.style.display = 'none';
                startCamera();
            });

        } catch (error) {
            console.error("Model load failed:", error);
            titleText.innerHTML = "Connection Failed!<br><span style='font-size:10px'>Check network for first load</span>";
        }
    }

    // 2. 啟動攝影機
    async function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        facingMode: 'environment',
                        width: 640,
                        height: 480
                    }
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    isDetecting = true;
                    detectFrame();
                };
            } catch (e) {
                alert("Camera permission denied or not found!");
            }
        }
    }

    // 3. 繪製 Minecraft 風格 UI (Tooltip 風格)
    function drawMinecraftOverlay(x, y, w, h, text, color) {
        // A. 繪製物體框線 (更粗的像素感)
        ctx.lineWidth = 6; 
        ctx.strokeStyle = 'rgba(0,0,0,0.5)'; // 陰影層
        ctx.strokeRect(x + 2, y + 2, w, h); 

        ctx.lineWidth = 4;
        ctx.strokeStyle = color; // 物體顏色
        ctx.strokeRect(x, y, w, h);

        // B. 繪製文字標籤 (模擬 Minecraft Tooltip)
        const fontSize = 16;
        ctx.font = `${fontSize}px "Press Start 2P", monospace`; // 加入 monospace 作為備用字體
        
        const padding = 8;
        const textMetrics = ctx.measureText(text);
        const textWidth = textMetrics.width;
        const boxHeight = fontSize + padding * 2;
        const boxWidth = textWidth + padding * 2;
        
        // 標籤位置 (框框上方)
        const labelX = x;
        const labelY = y - boxHeight - 4 > 0 ? y - boxHeight - 4 : y + 4; // 如果上方沒空間就畫在裡面

        // Tooltip 背景 (深紫色背景 #100010)
        ctx.fillStyle = '#100010';
        ctx.fillRect(labelX, labelY, boxWidth, boxHeight);
        
        // Tooltip 邊框 (紫色漸層模擬 #2a002a)
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#350040'; // 深紫邊框
        ctx.strokeRect(labelX, labelY, boxWidth, boxHeight);

        // 文字本身 (白色 + 陰影)
        ctx.fillStyle = '#3f3f3f'; // 文字陰影
        ctx.fillText(text, labelX + padding + 2, labelY + fontSize + padding + 2);
        
        ctx.fillStyle = '#ffffff'; // 文字白
        ctx.fillText(text, labelX + padding, labelY + fontSize + padding);
        
        // 如果是特殊物品，顯示物品稀有度顏色 (例如名字變成金色/藍色)
        if (color === '#FFD700') { // 針對 Player Head
             ctx.fillStyle = '#FFFF55'; // Minecraft Yellow
             ctx.fillText(text, labelX + padding, labelY + fontSize + padding);
        }
    }

    // 4. 偵測迴圈
    async function detectFrame() {
        if (!isDetecting) return;

        const now = performance.now();
        // 簡單的 FPS 限制 (避免手機過熱)
        if (now - lastTime < 30) { 
            requestAnimationFrame(detectFrame);
            return;
        }
        
        const fps = Math.round(1000 / (now - lastTime));
        lastTime = now;
        fpsText.innerText = `FPS: ${fps}`;

        // 推論
        const predictions = await model.detect(video);

        // 清除與重繪
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 保留像素化效果
        ctx.imageSmoothingEnabled = false; 
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 處理結果
        predictions.forEach(prediction => {
            // 取得原始類別並轉小寫
            const rawClass = prediction.class.toLowerCase();
            const [x, y, width, height] = prediction.bbox;

            // Debug: 在 Console 看看到底辨識出什麼
            // console.log("Detected:", rawClass); 

            let displayItem = DEFAULT_BLOCK;

            // 檢查映射表
            if (MINECRAFT_MAP[rawClass]) {
                displayItem = MINECRAFT_MAP[rawClass];
            } else {
                // 如果不在表內，就用原始名稱但套用像素風，或者強制顯示 Cobblestone
                // 這裡我們選擇: 顯示原始名稱，但當作 "Dirt" 處理
                displayItem = { 
                    name: rawClass.charAt(0).toUpperCase() + rawClass.slice(1), 
                    color: '#888888' 
                };
            }

            // 信心度過濾 > 60%
            if (prediction.score > 0.6) {
                drawMinecraftOverlay(x, y, width, height, displayItem.name, displayItem.color);
            }
        });

        requestAnimationFrame(detectFrame);
    }

    init();
</script>
