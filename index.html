<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft AR Vision Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0; background-color: #1e1e1e; overflow: hidden;
            font-family: 'Press Start 2P', monospace;
        }
        canvas {
            display: block; position: absolute; top: 0; left: 0; z-index: 1;
        }
        /* 載入介面 */
        #loading-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #2e1a0b; /* Dirt color */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10; color: #fff; text-align: center;
        }
        .mc-btn {
            margin-top: 20px; background: #7d7d7d;
            border: 4px solid #fff; border-bottom-color: #3b3b3b; border-right-color: #3b3b3b;
            padding: 15px 30px; color: #fff; font-family: inherit;
            cursor: pointer; text-shadow: 2px 2px #000;
        }
        /* 關鍵：把影片和素材圖片藏起來，不要顯示在網頁上 */
        .hidden-asset { display: none; }
    </style>
    <script src="https://unpkg.com/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://unpkg.com/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>
<body>

    <img id="img-steve" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACOFBMVEUAAAD///8AAQD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD///+x1X/fAAAAxnRSTlMAAAAAAAAJCQsTEx0dJSUtLTMzPT1JSU1NWVldXWVlbW11dYSEhI2NlZmlpa2ttbXFxdXV5eX19fX///8A/wD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAAP//AP8AAP8AAAD//wD/AAD/AAAAl2Z8MQAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAHdElNRQfpCxwUJDc01/xOAAAAbElEQVQ4y2NgwA04mZDCnEzY5DDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5TDAhF0OA0zY5QAA8CwA8Zq1W5UAAAAASUVORK5CYII=">
    <img id="img-enchant" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAwBQTFRF////AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA////g3Y9zwAAABl0Uk5TAAAAAAATEx0dJSUtLTMzPT1JSU1NXV1lZb2933sAAAABYktHRACIBR1IAAAACXBIWXMAABJ0AAASdAHeZh94AAAAB3RJTUUH6QscFCo50/JqYQAAAGxJREFUOMtjYMACmBmRwMyITOAywISuFqQWhwm7HJA6mLDLAamDCbscwIcJu9yAcgM2OQxgwi4HoA4m7HJAAiYwYZcDUgcTdjkAdTBhlwM6YIITdjkAdTBhlwM6YIITdjkAdTBhlwM6YIITdjEAAP7IAPG/KkQzAAAAAElFTkSuQmCC">
    <img id="img-crafting" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAFdQTFRFAAAA////gICA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAABFvPEeAAAAJ3RSTlMAAAAAExMdHSUlLS0zMz09SUlNTV1dZWVtbfX1////////////////38k19AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAASdAAAEnQB3mYfeAAAAAd0SU1FB+kLHBQtE9S007wAAABTSURBVDjLY2DABpgZkcDMiEzgMsCErhakFocJuxyQOpCwKwCoAwmbAgM2OQxgwi4HoA4k7HIAdSBhlwOoAwm7HEAdSNjlAOrAwq4ApA4k7HIAdSABAF3IAPF/9/Z1AAAAAElFTkSuQmCC">
    <img id="img-planks" class="hidden-asset" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAFdQTFRFAAAA////gICA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAABFvPEeAAAAJ3RSTlMAAAAAExMdHSUlLS0zMz09SUlNTV1dZWVtbfX1////////////////38k19AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAASdAAAEnQB3mYfeAAAAAd0SU1FB+kLHBQuFz0s2jUAAABTSURBVDjLY2DABpgZkcDMiEzgMsCErhakFocJuxyQOpCwKwCoAwmbAgM2OQxgwi4HoA4k7HIAdSBhlwOoAwm7HEAdSNjlAOrAwq4ApA4k7HIAdSABAF3IAPF/9/Z1AAAAAElFTkSuQmCC">
    <div id="loading-ui">
        <h1 style="text-shadow: 4px 4px #000; line-height: 1.5;">MINECRAFT<br><span style="color:#FFFF55; font-size:0.6em;">AR Overlay</span></h1>
        <p id="status" style="color:#aaa; font-size: 10px; margin-top:20px;">Loading Model...</p>
        <button id="start-btn" class="mc-btn" style="display:none;">Start Game</button>
    </div>

    <video id="video-source" class="hidden-asset" playsinline muted></video>
    <canvas id="output"></canvas>

<script>
    // === 1. 映射表 (改成對應 HTML 裡的圖片 ID) ===
    const MC_MAP = {
        'person':       { name: 'Steve',            imgId: 'img-steve',    color: '#FFD700' },
        'laptop':       { name: 'Enchanting Table', imgId: 'img-enchant',  color: '#b5651d' },
        'tv':           { name: 'Enchanting Table', imgId: 'img-enchant',  color: '#2a002a' },
        'keyboard':     { name: 'Pressure Plate',   imgId: 'img-planks',   color: '#aaaaaa' },
        'cell phone':   { name: 'Map',              imgId: 'img-crafting', color: '#ffffff' },
        'chair':        { name: 'Oak Stairs',       imgId: 'img-planks',   color: '#b8860b' },
        'dining table': { name: 'Crafting Table',   imgId: 'img-crafting', color: '#8b4513' },
    };
    
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('start-btn');
    const loadingUi = document.getElementById('loading-ui');

    let model = null;

    // === 2. 初始化 AI (不需要再預載圖片了) ===
    async function initAI() {
        try {
            model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            statusText.innerText = "Ready!";
            startBtn.style.display = 'inline-block';
            startBtn.onclick = startCamera;
        } catch (e) {
            statusText.innerText = "Error: " + e.message;
        }
    }

    // === 3. 啟動攝影機 ===
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false, video: { facingMode: 'environment' }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                loadingUi.style.display = 'none';
                resizeCanvas();
                detectFrame();
            };
        } catch (e) {
            alert("Camera Access Denied");
        }
    }

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.onresize = resizeCanvas;

    // === 4. 偵測與繪圖 ===
    async function detectFrame() {
        // 計算畫面比例 (解決壓扁問題)
        const screenRatio = canvas.width / canvas.height;
        const videoRatio = video.videoWidth / video.videoHeight;
        let drawW, drawH, startX, startY, scale;

        if (screenRatio > videoRatio) {
            drawW = canvas.width; drawH = canvas.width / videoRatio;
            startX = 0; startY = (canvas.height - drawH) / 2;
            scale = canvas.width / video.videoWidth;
        } else {
            drawW = canvas.height * videoRatio; drawH = canvas.height;
            startX = (canvas.width - drawW) / 2; startY = 0;
            scale = canvas.height / video.videoHeight;
        }

        ctx.drawImage(video, startX, startY, drawW, drawH);

        const predictions = await model.detect(video);

        predictions.forEach(prediction => {
            if (prediction.score > 0.5) {
                const x = prediction.bbox[0] * scale + startX;
                const y = prediction.bbox[1] * scale + startY;
                const w = prediction.bbox[2] * scale;
                const h = prediction.bbox[3] * scale;
                const rawClass = prediction.class.toLowerCase();
                
                // 取得對應資料
                let item = MC_MAP[rawClass] || { 
                    name: rawClass, imgId: 'img-planks', color: '#aaa' 
                };

                // 畫框
                ctx.lineWidth = 4;
                ctx.strokeStyle = item.color;
                ctx.strokeRect(x, y, w, h);

                // Tooltip 設定
                const text = item.name;
                const iconSize = 32;
                const padding = 8;
                ctx.font = `16px "Press Start 2P", monospace`;
                const textW = ctx.measureText(text).width;
                const boxW = iconSize + textW + padding * 3;
                const boxH = iconSize + padding * 2;
                
                let tx = x; let ty = y - boxH - 10;
                if (ty < 0) ty = y + 10;

                // 畫底色
                ctx.fillStyle = "rgba(16, 0, 16, 0.9)";
                ctx.fillRect(tx, ty, boxW, boxH);
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#300060";
                ctx.strokeRect(tx, ty, boxW, boxH);

                // === 關鍵修改：直接從 HTML 抓圖片來畫 ===
                const imgElement = document.getElementById(item.imgId);
                if (imgElement) {
                    ctx.imageSmoothingEnabled = false; // 保持像素風
                    ctx.drawImage(imgElement, tx + padding, ty + padding, iconSize, iconSize);
                }

                // 畫文字
                ctx.fillStyle = item.color;
                if (item.name === 'Steve') ctx.fillStyle = '#FFFF55';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, tx + padding + iconSize + padding, ty + boxH/2);
            }
        });
        requestAnimationFrame(detectFrame);
    }

    // 啟動
    initAI();

</script>
</body>
</html>
