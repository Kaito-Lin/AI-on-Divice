<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft AI Vision Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        :root {
            --mc-bg: #1e1e1e;
            --mc-btn: #7d7d7d;
            --mc-btn-shadow: #3b3b3b;
            --mc-text: #ffffff;
            --mc-green: #55ff55;
            --mc-gold: #ffaa00;
        }

        body {
            margin: 0;
            background-color: #111;
            font-family: 'Press Start 2P', cursive;
            color: var(--mc-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        /* Minecraft UI Container */
        #game-container {
            position: relative;
            border: 4px solid #555;
            box-shadow: 0 0 0 4px #222;
            width: 640px;
            height: 480px;
            background: #000;
            max-width: 95vw;
        }

        /* 隱藏原始 Video，只顯示 Canvas */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: fill;
            visibility: hidden; 
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; /* 關鍵：讓繪圖保持像素風 */
        }

        /* Loading Screen UI */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .mc-title {
            font-size: 24px;
            color: var(--mc-text);
            text-shadow: 2px 2px #000;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .mc-button {
            background-color: var(--mc-btn);
            border: 2px solid #fff;
            border-right-color: var(--mc-btn-shadow);
            border-bottom-color: var(--mc-btn-shadow);
            color: #fff;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            text-shadow: 1px 1px #000;
        }
        
        .mc-button:active {
            border: 2px solid var(--mc-btn-shadow);
            border-right-color: #fff;
            border-bottom-color: #fff;
        }

        /* Debug Stats */
        #fps-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--mc-gold);
            font-size: 10px;
            text-shadow: 1px 1px #000;
            z-index: 5;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="fps-counter">FPS: 0</div>
        
        <div id="loading-screen">
            <div class="mc-title">Building Terrain...<br><span style="font-size:12px; color:#aaa;">(Loading AI Model)</span></div>
            <button id="start-btn" class="mc-button" style="display:none;">Start Game</button>
        </div>

        <video id="webcam" playsinline autoplay muted></video>
        <canvas id="output"></canvas>
    </div>

<script>
    /**
     * Minecraft 物品映射表
     * 鍵值為 COCO-SSD 模型辨識出的 class 名稱
     */
    const MINECRAFT_MAP = {
        'person': { name: 'Player Head', color: '#FFD700' },     // 金色
        'tv': { name: 'Enchanting Table', color: '#b5651d' },    // 電腦螢幕 -> 附魔台
        'laptop': { name: 'Enchanting Table', color: '#b5651d' },
        'chair': { name: 'Oak Stairs', color: '#8B4513' },       // 木色
        'dining table': { name: 'Crafting Table', color: '#A0522D' },
        'keyboard': { name: 'Stone Button', color: '#777' },
        'mouse': { name: 'Lever', color: '#777' },
        'cell phone': { name: 'Map', color: '#fff' }
    };

    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const loadingScreen = document.getElementById('loading-screen');
    const startBtn = document.getElementById('start-btn');
    const titleText = document.querySelector('.mc-title');
    const fpsText = document.getElementById('fps-counter');

    let model = null;
    let isDetecting = false;
    let lastTime = 0;

    // 1. 初始化模型
    async function init() {
        try {
            // 載入 COCO-SSD 模型 (MobileNet V2 後端)
            model = await cocoSsd.load();
            titleText.innerHTML = "World Loaded!";
            startBtn.style.display = 'block';
            
            startBtn.addEventListener('click', () => {
                loadingScreen.style.display = 'none';
                startCamera();
            });

        } catch (error) {
            console.error(error);
            titleText.innerHTML = "Connection Lost!<br><span style='font-size:10px'>Check Internet for 1st load</span>";
        }
    }

    // 2. 啟動攝影機
    async function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    facingMode: 'environment', // 優先使用後鏡頭
                    width: 640,
                    height: 480
                }
            });
            video.srcObject = stream;
            
            // 等待影片 metadata 載入完畢後設定 canvas 尺寸
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                isDetecting = true;
                detectFrame();
            };
        }
    }

    // 3. 繪製 Minecraft 風格邊框
    function drawMinecraftBox(x, y, w, h, label, color) {
        // 粗邊框
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#000'; // 黑色陰影邊框
        ctx.strokeRect(x, y, w, h);
        
        ctx.lineWidth = 2;
        ctx.strokeStyle = color; // 物品代表色
        ctx.strokeRect(x, y, w, h);

        // 標籤背景 (Tooltip 風格)
        const text = label;
        const fontSize = 12;
        ctx.font = `${fontSize}px "Press Start 2P"`;
        const textWidth = ctx.measureText(text).width;
        const padding = 6;
        
        // 標籤背景框 (半透明黑)
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(x, y - fontSize - padding * 2, textWidth + padding * 2, fontSize + padding * 2);
        
        // 標籤邊框
        ctx.strokeStyle = '#555'; // 石頭色邊框
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y - fontSize - padding * 2, textWidth + padding * 2, fontSize + padding * 2);

        // 文字
        ctx.fillStyle = '#fff';
        ctx.fillText(text, x + padding, y - padding);
    }

    // 4. 偵測迴圈
    async function detectFrame() {
        if (!isDetecting) return;

        // 計算 FPS
        const now = performance.now();
        const fps = Math.round(1000 / (now - lastTime));
        lastTime = now;
        fpsText.innerText = `FPS: ${fps}`;

        // 進行推論
        const predictions = await model.detect(video);

        // 清除畫布並重繪影像
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 繪製偵測結果
        predictions.forEach(prediction => {
            const className = prediction.class;
            
            // 檢查是否在我們的 Minecraft 映射表中
            if (MINECRAFT_MAP[className]) {
                const mcItem = MINECRAFT_MAP[className];
                const [x, y, width, height] = prediction.bbox;
                
                // 過濾信心度太低的 (可選)
                if (prediction.score > 0.5) {
                    drawMinecraftBox(x, y, width, height, mcItem.name, mcItem.color);
                }
            } else {
                // (選用) 顯示未定義物品，或是忽略
                // const [x, y, width, height] = prediction.bbox;
                // drawMinecraftBox(x, y, width, height, className, '#aaa');
            }
        });

        requestAnimationFrame(detectFrame);
    }

    // 啟動程式
    init();

</script>
</body>
</html>
